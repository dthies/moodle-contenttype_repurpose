{"version":3,"file":"editbackground.min.js","sources":["../src/editbackground.js"],"sourcesContent":["import FormUpdate from 'contenttype_repurpose/formupdate';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport Modal from 'core/modal_save_cancel';\nimport notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport templates from 'core/templates';\n\n/**\n * Initialize listeners\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n */\nexport const init = async(contextid, library, cmid) => {\n    'use strict';\n    let form;\n\n    try {\n        const modal = await Modal.create({\n            large: false,\n            title: getString('addfile', 'contenttype_repurpose'),\n            body: ''\n        });\n        const root = modal.getRoot();\n        root.on('submit', function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, cmid, form, data, modal);\n            modal.hide();\n        });\n        root.on(ModalEvents.save, function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, cmid, form, data, modal);\n            modal.hide();\n        });\n\n        document.addEventListener('click', e => {\n            let button = e.target.closest('[data-action=\"edit\"], button[name=\"backgroundimage[addfile]\"]');\n            if (button) {\n                e.stopPropagation();\n                e.preventDefault();\n                form = e.target.closest('form');\n                editForm(contextid, library, cmid, form, button, modal);\n            }\n        }, true);\n    } catch (e) {\n        notification.exception(e);\n    }\n\n    document.addEventListener('click', edit.bind(window, contextid, cmid, library));\n};\n/**\n * Open editing modal\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {DOMNode} form Node for main form\n * @param {DOMNode} button The button that was clicked\n * @param {object} modal\n */\nconst editForm = function(contextid, library, cmid, form, button, modal) {\n    'use strict';\n\n    let formdata = new FormData(form),\n        background = formdata.get('background'),\n        data = {\n            draftid: formdata.get('draftid'),\n        },\n        params = {\n            contextid: contextid,\n            library: library\n        };\n    if (background) {\n        data.license = JSON.parse(background).metadata.license;\n    }\n    params.jsonformdata = JSON.stringify(data);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n        modal.show();\n        templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n    }).fail(notification.exception);\n};\n\n/**\n * Submit form and handle response\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {DOMNode} form Node for main form\n * @param {FormData} data Modal data\n */\nconst saveForm = function(contextid, library, cmid, form, data) {\n    'use strict';\n\n    let formdata = {},\n        params = {\n            contextid: contextid,\n            library: library\n        };\n    data.forEach((value, key) => {\n        formdata[key] = value;\n    });\n    params.jsonformdata = JSON.stringify(formdata);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html) {\n        let result;\n        try {\n            result = JSON.parse(html);\n        } catch (e) {\n            result = JSON.parse(form.querySelector('input[name=\"background\"]').getAttribute('value'));\n        }\n        result.metadata.license = data.get('license');\n        form.querySelector('input[name=\"background\"]').setAttribute('value', JSON.stringify(result));\n        FormUpdate.updateForm(contextid, library, cmid, form);\n    }).fail(notification.exception);\n};\n\n/**\n * Handle editing action\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {event} e Event\n */\nexport const edit = function(contextid, library, cmid, e) {\n    'use strict';\n\n    let button = e.target.closest('[data-action=\"delete\"]');\n    if (button) {\n        let form = button.closest('form');\n        e.stopPropagation();\n        e.preventDefault();\n\n        form.querySelector('input[name=\"background\"]').setAttribute('value', '');\n        FormUpdate.updateForm(contextid, library, cmid, form);\n    }\n};\n"],"names":["async","contextid","library","cmid","form","modal","Modal","create","large","title","body","root","getRoot","on","e","data","FormData","find","get","stopPropagation","preventDefault","saveForm","hide","ModalEvents","save","document","addEventListener","button","target","closest","editForm","exception","edit","bind","window","formdata","background","draftid","params","license","JSON","parse","metadata","jsonformdata","stringify","loadFragment","done","html","js","show","replaceNodeContents","fail","notification","forEach","value","key","result","querySelector","getAttribute","setAttribute","updateForm"],"mappings":"8xBAeoBA,MAAMC,UAAWC,QAASC,YAEtCC,eAGMC,YAAcC,2BAAMC,OAAO,CAC7BC,OAAO,EACPC,OAAO,mBAAU,UAAW,yBAC5BC,KAAM,KAEJC,KAAON,MAAMO,UACnBD,KAAKE,GAAG,UAAU,SAASC,OACnBC,KAAO,IAAIC,SAASL,KAAKM,KAAK,QAAQC,IAAI,IAC9CJ,EAAEK,kBACFL,EAAEM,iBACFC,SAASpB,UAAWC,QAASC,KAAMC,KAAMW,KAAMV,OAC/CA,MAAMiB,UAEVX,KAAKE,GAAGU,sBAAYC,MAAM,SAASV,OAC3BC,KAAO,IAAIC,SAASL,KAAKM,KAAK,QAAQC,IAAI,IAC9CJ,EAAEK,kBACFL,EAAEM,iBACFC,SAASpB,UAAWC,QAASC,KAAMC,KAAMW,KAAMV,OAC/CA,MAAMiB,UAGVG,SAASC,iBAAiB,SAASZ,QAC3Ba,OAASb,EAAEc,OAAOC,QAAQ,iEAC1BF,SACAb,EAAEK,kBACFL,EAAEM,iBACFhB,KAAOU,EAAEc,OAAOC,QAAQ,QACxBC,SAAS7B,UAAWC,QAASC,KAAMC,KAAMuB,OAAQtB,WAEtD,GACL,MAAOS,yBACQiB,UAAUjB,GAG3BW,SAASC,iBAAiB,QAASM,KAAKC,KAAKC,OAAQjC,UAAWE,KAAMD,iBAYpE4B,SAAW,SAAS7B,UAAWC,QAASC,KAAMC,KAAMuB,OAAQtB,WAG1D8B,SAAW,IAAInB,SAASZ,MACxBgC,WAAaD,SAASjB,IAAI,cAC1BH,KAAO,CACHsB,QAASF,SAASjB,IAAI,YAE1BoB,OAAS,CACLrC,UAAWA,UACXC,QAASA,SAEbkC,aACArB,KAAKwB,QAAUC,KAAKC,MAAML,YAAYM,SAASH,SAEnDD,OAAOK,aAAeH,KAAKI,UAAU7B,wBAC5B8B,aAAa,wBAAyB,UAAW5C,UAAWqC,QAAQQ,MAAK,SAASC,KAAMC,IAC7F3C,MAAM4C,0BACIC,oBAAoB7C,MAAMO,UAAUK,KAAK,eAAgB8B,KAAMC,OAC1EG,KAAKC,sBAAarB,YAYnBV,SAAW,SAASpB,UAAWC,QAASC,KAAMC,KAAMW,UAGlDoB,SAAW,GACXG,OAAS,CACLrC,UAAWA,UACXC,QAASA,SAEjBa,KAAKsC,SAAQ,CAACC,MAAOC,OACjBpB,SAASoB,KAAOD,SAEpBhB,OAAOK,aAAeH,KAAKI,UAAUT,4BAC5BU,aAAa,wBAAyB,UAAW5C,UAAWqC,QAAQQ,MAAK,SAASC,UACnFS,WAEAA,OAAShB,KAAKC,MAAMM,MACtB,MAAOjC,GACL0C,OAAShB,KAAKC,MAAMrC,KAAKqD,cAAc,4BAA4BC,aAAa,UAEpFF,OAAOd,SAASH,QAAUxB,KAAKG,IAAI,WACnCd,KAAKqD,cAAc,4BAA4BE,aAAa,QAASnB,KAAKI,UAAUY,6BACzEI,WAAW3D,UAAWC,QAASC,KAAMC,SACjD+C,KAAKC,sBAAarB,YAWZC,KAAO,SAAS/B,UAAWC,QAASC,KAAMW,OAG/Ca,OAASb,EAAEc,OAAOC,QAAQ,6BAC1BF,OAAQ,KACJvB,KAAOuB,OAAOE,QAAQ,QAC1Bf,EAAEK,kBACFL,EAAEM,iBAEFhB,KAAKqD,cAAc,4BAA4BE,aAAa,QAAS,wBAC1DC,WAAW3D,UAAWC,QAASC,KAAMC"}