{"version":3,"sources":["../src/editbackground.js"],"names":["init","contextid","library","form","ModalFactory","create","large","title","type","types","SAVE_CANCEL","body","then","modal","root","getRoot","on","e","data","FormData","find","get","stopPropagation","preventDefault","saveForm","hide","ModalEvents","save","document","addEventListener","button","target","closest","editForm","fail","notification","exception","edit","bind","window","formdata","draftid","params","jsonformdata","JSON","stringify","Fragment","loadFragment","done","html","js","show","templates","replaceNodeContents","forEach","value","key","result","parse","querySelector","setAttribute","file","path","FormUpdate","updateForm"],"mappings":"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","sourcesContent":["import FormUpdate from 'contenttype_repurpose/formupdate';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport templates from 'core/templates';\n\n/**\n * Initialize listeners\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n */\nexport const init = (contextid, library) => {\n    'use strict';\n    let form;\n\n    ModalFactory.create({\n        large: false,\n        title: getString('addfile', 'contenttype_repurpose'),\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: ''\n    }).then(function(modal) {\n        let root = modal.getRoot();\n        root.on('submit', function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n        root.on(ModalEvents.save, function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n\n        document.addEventListener('click', e => {\n            let button = e.target.closest('[data-action=\"edit\"], button[name=\"backgroundimage[addfile]\"]');\n            if (button) {\n                e.stopPropagation();\n                e.preventDefault();\n                form = e.target.closest('form');\n                editForm(contextid, library, form, button, modal);\n            }\n        }, true);\n    }).fail(notification.exception);\n\n    document.addEventListener('click', edit.bind(window, contextid, library));\n};\n/**\n * Open editing modal\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {DOMNode} form Node for main form\n * @param {DOMNode} button The button that was clicked\n * @param {object} modal\n */\nconst editForm = function(contextid, library, form, button, modal) {\n    'use strict';\n\n    let formdata = new FormData(form),\n        data = {\n            draftid: formdata.get('draftid'),\n        },\n        params = {\n            contextid: contextid,\n            library: library\n        };\n    params.jsonformdata = JSON.stringify(data);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n        modal.show();\n        templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n    }).fail(notification.exception);\n};\n\n/**\n * Submit form and handle response\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {DOMNode} form Node for main form\n * @param {FormData} data Modal data\n * @param {object} modal\n */\nconst saveForm = function(contextid, library, form, data, modal) {\n    'use strict';\n\n    let formdata = {},\n        params = {\n            contextid: contextid,\n            library: library\n        };\n    data.forEach((value, key) => {\n        formdata[key] = value;\n    });\n        params.jsonformdata = JSON.stringify(formdata);\n        Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n            let result = JSON.parse(html);\n            if (result) {\n                form.querySelector('input[name=\"background\"]').setAttribute('value', result.params.file.path);\n                FormUpdate.updateForm(contextid, library, form);\n            } else {\n                modal.show();\n                templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n            }\n        }).fail(notification.exception);\n};\n\n/**\n * Handle editing action\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {event} e Event\n */\nexport const edit = function(contextid, library, e) {\n    'use strict';\n\n    let button = e.target.closest('[data-action=\"delete\"]');\n    if (button) {\n        let form = button.closest('form');\n        e.stopPropagation();\n        e.preventDefault();\n\n        form.querySelector('input[name=\"background\"]').setAttribute('value', '');\n        FormUpdate.updateForm(contextid, library, form);\n    }\n};\n"],"file":"editbackground.min.js"}