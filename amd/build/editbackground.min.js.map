{"version":3,"file":"editbackground.min.js","sources":["../src/editbackground.js"],"sourcesContent":["import FormUpdate from 'contenttype_repurpose/formupdate';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport templates from 'core/templates';\n\n/**\n * Initialize listeners\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n */\nexport const init = (contextid, library, cmid) => {\n    'use strict';\n    let form;\n\n    ModalFactory.create({\n        large: false,\n        title: getString('addfile', 'contenttype_repurpose'),\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: ''\n    }).then(function(modal) {\n        let root = modal.getRoot();\n        root.on('submit', function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, cmid, form, data, modal);\n            modal.hide();\n        });\n        root.on(ModalEvents.save, function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, cmid, form, data, modal);\n            modal.hide();\n        });\n\n        document.addEventListener('click', e => {\n            let button = e.target.closest('[data-action=\"edit\"], button[name=\"backgroundimage[addfile]\"]');\n            if (button) {\n                e.stopPropagation();\n                e.preventDefault();\n                form = e.target.closest('form');\n                editForm(contextid, library, cmid, form, button, modal);\n            }\n        }, true);\n\n        return true;\n    }).fail(notification.exception);\n\n    document.addEventListener('click', edit.bind(window, contextid, cmid, library));\n};\n/**\n * Open editing modal\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {DOMNode} form Node for main form\n * @param {DOMNode} button The button that was clicked\n * @param {object} modal\n */\nconst editForm = function(contextid, library, cmid, form, button, modal) {\n    'use strict';\n\n    let formdata = new FormData(form),\n        background = formdata.get('background'),\n        data = {\n            draftid: formdata.get('draftid'),\n        },\n        params = {\n            contextid: contextid,\n            library: library\n        };\n    if (background) {\n        data.license = JSON.parse(background).metadata.license;\n    }\n    params.jsonformdata = JSON.stringify(data);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n        modal.show();\n        templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n    }).fail(notification.exception);\n};\n\n/**\n * Submit form and handle response\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {DOMNode} form Node for main form\n * @param {FormData} data Modal data\n */\nconst saveForm = function(contextid, library, cmid, form, data) {\n    'use strict';\n\n    let formdata = {},\n        params = {\n            contextid: contextid,\n            library: library\n        };\n    data.forEach((value, key) => {\n        formdata[key] = value;\n    });\n    params.jsonformdata = JSON.stringify(formdata);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html) {\n        let result;\n        try {\n            result = JSON.parse(html);\n        } catch (e) {\n            result = JSON.parse(form.querySelector('input[name=\"background\"]').getAttribute('value'));\n        }\n        result.metadata.license = data.get('license');\n        form.querySelector('input[name=\"background\"]').setAttribute('value', JSON.stringify(result));\n        FormUpdate.updateForm(contextid, library, cmid, form);\n    }).fail(notification.exception);\n};\n\n/**\n * Handle editing action\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {event} e Event\n */\nexport const edit = function(contextid, library, cmid, e) {\n    'use strict';\n\n    let button = e.target.closest('[data-action=\"delete\"]');\n    if (button) {\n        let form = button.closest('form');\n        e.stopPropagation();\n        e.preventDefault();\n\n        form.querySelector('input[name=\"background\"]').setAttribute('value', '');\n        FormUpdate.updateForm(contextid, library, cmid, form);\n    }\n};\n"],"names":["contextid","library","cmid","form","create","large","title","type","ModalFactory","types","SAVE_CANCEL","body","then","modal","root","getRoot","on","e","data","FormData","find","get","stopPropagation","preventDefault","saveForm","hide","ModalEvents","save","document","addEventListener","button","target","closest","editForm","fail","notification","exception","edit","bind","window","formdata","background","draftid","params","license","JSON","parse","metadata","jsonformdata","stringify","loadFragment","done","html","js","show","replaceNodeContents","forEach","value","key","result","querySelector","getAttribute","setAttribute","updateForm"],"mappings":"8wBAeoB,CAACA,UAAWC,QAASC,YAEjCC,4BAESC,OAAO,CAChBC,OAAO,EACPC,OAAO,mBAAU,UAAW,yBAC5BC,KAAMC,uBAAaC,MAAMC,YACzBC,KAAM,KACPC,MAAK,SAASC,WACTC,KAAOD,MAAME,iBACjBD,KAAKE,GAAG,UAAU,SAASC,OACnBC,KAAO,IAAIC,SAASL,KAAKM,KAAK,QAAQC,IAAI,IAC9CJ,EAAEK,kBACFL,EAAEM,iBACFC,SAASxB,UAAWC,QAASC,KAAMC,KAAMe,KAAML,OAC/CA,MAAMY,UAEVX,KAAKE,GAAGU,sBAAYC,MAAM,SAASV,OAC3BC,KAAO,IAAIC,SAASL,KAAKM,KAAK,QAAQC,IAAI,IAC9CJ,EAAEK,kBACFL,EAAEM,iBACFC,SAASxB,UAAWC,QAASC,KAAMC,KAAMe,KAAML,OAC/CA,MAAMY,UAGVG,SAASC,iBAAiB,SAASZ,QAC3Ba,OAASb,EAAEc,OAAOC,QAAQ,iEAC1BF,SACAb,EAAEK,kBACFL,EAAEM,iBACFpB,KAAOc,EAAEc,OAAOC,QAAQ,QACxBC,SAASjC,UAAWC,QAASC,KAAMC,KAAM2B,OAAQjB,WAEtD,IAEI,KACRqB,KAAKC,sBAAaC,WAErBR,SAASC,iBAAiB,QAASQ,KAAKC,KAAKC,OAAQvC,UAAWE,KAAMD,iBAYpEgC,SAAW,SAASjC,UAAWC,QAASC,KAAMC,KAAM2B,OAAQjB,WAG1D2B,SAAW,IAAIrB,SAAShB,MACxBsC,WAAaD,SAASnB,IAAI,cAC1BH,KAAO,CACHwB,QAASF,SAASnB,IAAI,YAE1BsB,OAAS,CACL3C,UAAWA,UACXC,QAASA,SAEbwC,aACAvB,KAAK0B,QAAUC,KAAKC,MAAML,YAAYM,SAASH,SAEnDD,OAAOK,aAAeH,KAAKI,UAAU/B,wBAC5BgC,aAAa,wBAAyB,UAAWlD,UAAW2C,QAAQQ,MAAK,SAASC,KAAMC,IAC7FxC,MAAMyC,0BACIC,oBAAoB1C,MAAME,UAAUK,KAAK,eAAgBgC,KAAMC,OAC1EnB,KAAKC,sBAAaC,YAYnBZ,SAAW,SAASxB,UAAWC,QAASC,KAAMC,KAAMe,UAGlDsB,SAAW,GACXG,OAAS,CACL3C,UAAWA,UACXC,QAASA,SAEjBiB,KAAKsC,SAAQ,CAACC,MAAOC,OACjBlB,SAASkB,KAAOD,SAEpBd,OAAOK,aAAeH,KAAKI,UAAUT,4BAC5BU,aAAa,wBAAyB,UAAWlD,UAAW2C,QAAQQ,MAAK,SAASC,UACnFO,WAEAA,OAASd,KAAKC,MAAMM,MACtB,MAAOnC,GACL0C,OAASd,KAAKC,MAAM3C,KAAKyD,cAAc,4BAA4BC,aAAa,UAEpFF,OAAOZ,SAASH,QAAU1B,KAAKG,IAAI,WACnClB,KAAKyD,cAAc,4BAA4BE,aAAa,QAASjB,KAAKI,UAAUU,6BACzEI,WAAW/D,UAAWC,QAASC,KAAMC,SACjD+B,KAAKC,sBAAaC,YAWZC,KAAO,SAASrC,UAAWC,QAASC,KAAMe,OAG/Ca,OAASb,EAAEc,OAAOC,QAAQ,6BAC1BF,OAAQ,KACJ3B,KAAO2B,OAAOE,QAAQ,QAC1Bf,EAAEK,kBACFL,EAAEM,iBAEFpB,KAAKyD,cAAc,4BAA4BE,aAAa,QAAS,wBAC1DC,WAAW/D,UAAWC,QAASC,KAAMC"}