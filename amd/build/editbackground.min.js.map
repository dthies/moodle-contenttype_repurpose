{"version":3,"sources":["../src/editbackground.js"],"names":["init","contextid","library","form","ModalFactory","create","large","title","type","types","SAVE_CANCEL","body","then","modal","root","getRoot","on","e","data","FormData","find","get","stopPropagation","preventDefault","saveForm","hide","ModalEvents","save","document","addEventListener","button","target","closest","editForm","fail","notification","exception","edit","bind","window","formdata","background","draftid","params","license","JSON","parse","metadata","jsonformdata","stringify","Fragment","loadFragment","done","html","js","show","templates","replaceNodeContents","forEach","value","key","result","querySelector","getAttribute","setAttribute","FormUpdate","updateForm"],"mappings":"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","sourcesContent":["import FormUpdate from 'contenttype_repurpose/formupdate';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport templates from 'core/templates';\n\n/**\n * Initialize listeners\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n */\nexport const init = (contextid, library) => {\n    'use strict';\n    let form;\n\n    ModalFactory.create({\n        large: false,\n        title: getString('addfile', 'contenttype_repurpose'),\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: ''\n    }).then(function(modal) {\n        let root = modal.getRoot();\n        root.on('submit', function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n        root.on(ModalEvents.save, function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n\n        document.addEventListener('click', e => {\n            let button = e.target.closest('[data-action=\"edit\"], button[name=\"backgroundimage[addfile]\"]');\n            if (button) {\n                e.stopPropagation();\n                e.preventDefault();\n                form = e.target.closest('form');\n                editForm(contextid, library, form, button, modal);\n            }\n        }, true);\n\n        return true;\n    }).fail(notification.exception);\n\n    document.addEventListener('click', edit.bind(window, contextid, library));\n};\n/**\n * Open editing modal\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {DOMNode} form Node for main form\n * @param {DOMNode} button The button that was clicked\n * @param {object} modal\n */\nconst editForm = function(contextid, library, form, button, modal) {\n    'use strict';\n\n    let formdata = new FormData(form),\n        background = formdata.get('background'),\n        data = {\n            draftid: formdata.get('draftid'),\n        },\n        params = {\n            contextid: contextid,\n            library: library\n        };\n    if (background) {\n        data.license = JSON.parse(background).metadata.license;\n    }\n    params.jsonformdata = JSON.stringify(data);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n        modal.show();\n        templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n    }).fail(notification.exception);\n};\n\n/**\n * Submit form and handle response\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {DOMNode} form Node for main form\n * @param {FormData} data Modal data\n */\nconst saveForm = function(contextid, library, form, data) {\n    'use strict';\n\n    let formdata = {},\n        params = {\n            contextid: contextid,\n            library: library\n        };\n    data.forEach((value, key) => {\n        formdata[key] = value;\n    });\n    params.jsonformdata = JSON.stringify(formdata);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html) {\n        let result;\n        try {\n            result = JSON.parse(html);\n        } catch (e) {\n            result = JSON.parse(form.querySelector('input[name=\"background\"]').getAttribute('value'));\n        }\n        result.metadata.license = data.get('license');\n        form.querySelector('input[name=\"background\"]').setAttribute('value', JSON.stringify(result));\n        FormUpdate.updateForm(contextid, library, form);\n    }).fail(notification.exception);\n};\n\n/**\n * Handle editing action\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {event} e Event\n */\nexport const edit = function(contextid, library, e) {\n    'use strict';\n\n    let button = e.target.closest('[data-action=\"delete\"]');\n    if (button) {\n        let form = button.closest('form');\n        e.stopPropagation();\n        e.preventDefault();\n\n        form.querySelector('input[name=\"background\"]').setAttribute('value', '');\n        FormUpdate.updateForm(contextid, library, form);\n    }\n};\n"],"file":"editbackground.min.js"}