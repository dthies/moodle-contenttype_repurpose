define("contenttype_repurpose/editcontent",["exports","contenttype_repurpose/formupdate","core/fragment","core/modal_events","core/modal_factory","core/notification","core/str","core/templates"],(function(_exports,_formupdate,_fragment,_modal_events,_modal_factory,_notification,_str,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=_exports.edit=void 0,_formupdate=_interopRequireDefault(_formupdate),_fragment=_interopRequireDefault(_fragment),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates);_exports.init=(contextid,library)=>{let form;_modal_factory.default.create({large:!1,title:(0,_str.get_string)("editmedia","contenttype_repurpose"),type:_modal_factory.default.types.SAVE_CANCEL,body:""}).then((function(modal){let root=modal.getRoot();return root.on("submit",(function(e){let data=new FormData(root.find("form").get(0));e.stopPropagation(),e.preventDefault(),saveForm(contextid,library,form,data,modal),modal.hide()})),root.on(_modal_events.default.save,(function(e){let data=new FormData(root.find("form").get(0));e.stopPropagation(),e.preventDefault(),saveForm(contextid,library,form,data,modal),modal.hide()})),document.addEventListener("click",(e=>{let button=e.target.closest('[data-action="edit"], button[name="addfile"]');button&&(e.stopPropagation(),e.preventDefault(),form=e.target.closest("form"),editForm(contextid,library,form,button,modal))}),!0),!0})).fail(_notification.default.exception),document.addEventListener("click",edit.bind(window,contextid,library))};const editForm=function(contextid,library,form,button,modal){let buttons=form.querySelectorAll('[data-action="edit"]'),formdata=new FormData(form),data={draftid:button.matches('[name="addfile"]')&&formdata.get("draftid"),key:buttons.length},params={contextid:contextid,library:library},mediafiles=JSON.parse(formdata.get("mediafiles")||"[]");for(let i=0;i<buttons.length;i++)button.contains(buttons[i])&&(data.key=i,data.title=mediafiles[i].metadata.title||null,data.license=mediafiles[i].metadata.license||null);params.jsonformdata=JSON.stringify(data),_fragment.default.loadFragment("contenttype_repurpose","addfile",contextid,params).done((function(html,js){modal.show(),_templates.default.replaceNodeContents(modal.getRoot().find(".modal-body"),html,js)})).fail(_notification.default.exception)},saveForm=function(contextid,library,form,data,modal){let formdata=new FormData(form),key=data.get("key"),mediafiles=JSON.parse(formdata.get("mediafiles"));if(mediafiles[key])mediafiles[key].metadata.title=data.get("title"),mediafiles[key].metadata.license=data.get("license"),form.querySelector('input[name="mediafiles"]').setAttribute("value",JSON.stringify(mediafiles)),_formupdate.default.updateForm(contextid,library,form);else{let formdata={},params={contextid:contextid,library:library};data.forEach(((value,key)=>{formdata[key]=value})),params.jsonformdata=JSON.stringify(formdata),_fragment.default.loadFragment("contenttype_repurpose","addfile",contextid,params).done((function(html,js){try{let media=JSON.parse(html);media.metadata.license=data.get("license"),mediafiles[key]=media,form.querySelector('input[name="mediafiles"]').setAttribute("value",JSON.stringify(mediafiles)),_formupdate.default.updateForm(contextid,library,form)}catch(e){modal.show(),_templates.default.replaceNodeContents(modal.getRoot().find(".modal-body"),html,js)}})).fail(_notification.default.exception)}},edit=function(contextid,library,e){let button=e.target.closest('[data-action="delete"], [data-action="left"], [data-action="right"]');if(button){let buttons,data={},form=e.target.closest("form"),formdata=new FormData(form),mediafiles=JSON.parse(formdata.get("mediafiles"));switch(e.stopPropagation(),e.preventDefault(),formdata.forEach(((value,key)=>{data[key]=value})),button.getAttribute("data-action")){case"delete":buttons=form.querySelectorAll('[data-action="delete"]');for(let i=0;i<buttons.length;i++)button.contains(buttons.item(i))&&mediafiles.splice(i,1);break;case"left":buttons=form.querySelectorAll('[data-action="left"]');for(let i=0;i<buttons.length;i++)button.contains(buttons.item(i))&&mediafiles.splice(i,2,mediafiles[i+1],mediafiles[i]);break;case"right":buttons=form.querySelectorAll('[data-action="right"]');for(let i=0;i<buttons.length;i++)button.contains(buttons.item(i))&&mediafiles.splice(i,2,mediafiles[i+1],mediafiles[i])}form.querySelector('input[name="mediafiles"]').setAttribute("value",JSON.stringify(mediafiles)),_formupdate.default.updateForm(contextid,library,form)}};_exports.edit=edit}));

//# sourceMappingURL=editcontent.min.js.map