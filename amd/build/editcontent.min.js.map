{"version":3,"sources":["../src/editcontent.js"],"names":["init","contextid","library","form","ModalFactory","create","large","title","type","types","SAVE_CANCEL","body","then","modal","root","getRoot","on","e","data","FormData","find","get","stopPropagation","preventDefault","saveForm","hide","ModalEvents","save","document","addEventListener","button","target","closest","editForm","fail","notification","exception","edit","bind","window","buttons","querySelectorAll","formdata","draftid","matches","key","length","params","mediafiles","JSON","parse","i","contains","metadata","license","jsonformdata","stringify","Fragment","loadFragment","done","html","js","show","templates","replaceNodeContents","forEach","value","media","querySelector","setAttribute","FormUpdate","updateForm","getAttribute","item","splice"],"mappings":"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","sourcesContent":["import FormUpdate from 'contenttype_repurpose/formupdate';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport templates from 'core/templates';\n\n/**\n * Initialize listeners\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n */\nexport const init = (contextid, library) => {\n    'use strict';\n    let form;\n\n    ModalFactory.create({\n        large: false,\n        title: getString('editmedia', 'contenttype_repurpose'),\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: ''\n    }).then(function(modal) {\n        let root = modal.getRoot();\n        root.on('submit', function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n        root.on(ModalEvents.save, function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n\n        document.addEventListener('click', e => {\n            let button = e.target.closest('[data-action=\"edit\"], button[name=\"addfile\"]');\n            if (button) {\n                e.stopPropagation();\n                e.preventDefault();\n                form = e.target.closest('form');\n                editForm(contextid, library, form, button, modal);\n            }\n        }, true);\n    }).fail(notification.exception);\n\n    document.addEventListener('click', edit.bind(window, contextid, library));\n};\n/**\n * Open editing modal\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {DOMNode} form Node for main form\n * @param {DOMNode} button The button that was clicked\n * @param {object} modal\n */\nconst editForm = function(contextid, library, form, button, modal) {\n    'use strict';\n\n    let buttons = form.querySelectorAll('[data-action=\"edit\"]'),\n        formdata = new FormData(form),\n        data = {\n            draftid: button.matches('[name=\"addfile\"]') && formdata.get('draftid'),\n            key: buttons.length\n        },\n        params = {\n            contextid: contextid,\n            library: library\n        },\n        mediafiles = JSON.parse(formdata.get('mediafiles') || '[]');\n\n    for (let i = 0; i < buttons.length; i++) {\n        if (button.contains(buttons[i])) {\n            data.key = i;\n            data.title = mediafiles[i].metadata.title || null;\n            data.license = mediafiles[i].metadata.license || null;\n        }\n    }\n    params.jsonformdata = JSON.stringify(data);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n        modal.show();\n        templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n    }).fail(notification.exception);\n};\n\n/**\n * Submit form and handle response\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {DOMNode} form Node for main form\n * @param {FormData} data Modal data\n * @param {object} modal\n */\nconst saveForm = function(contextid, library, form, data, modal) {\n    'use strict';\n\n    let formdata = new FormData(form),\n        key = data.get('key'),\n        mediafiles = JSON.parse(formdata.get('mediafiles'));\n    if (!mediafiles[key]) {\n        let formdata = {},\n            params = {\n                contextid: contextid,\n                library: library\n            };\n        data.forEach((value, key) => {\n            formdata[key] = value;\n        });\n        params.jsonformdata = JSON.stringify(formdata);\n        Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n            let media = JSON.parse(html);\n            if (media) {\n                media.metadata.license = data.get('license');\n                mediafiles[key] = media;\n                form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n                FormUpdate.updateForm(contextid, library, form);\n            } else {\n                modal.show();\n                templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n            }\n        }).fail(notification.exception);\n    } else {\n        mediafiles[key].metadata.title = data.get('title');\n        mediafiles[key].metadata.license = data.get('license');\n        form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n        FormUpdate.updateForm(contextid, library, form);\n    }\n};\n\n/**\n * Handle editing action\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {event} e Event\n */\nexport const edit = function(contextid, library, e) {\n    'use strict';\n\n    let button = e.target.closest('[data-action=\"delete\"], [data-action=\"left\"], [data-action=\"right\"]');\n    if (button) {\n        let buttons,\n            data = {},\n            form = e.target.closest('form'),\n            formdata = new FormData(form),\n            mediafiles = JSON.parse(formdata.get('mediafiles'));\n        e.stopPropagation();\n        e.preventDefault();\n\n        formdata.forEach((value, key) => {\n            data[key] = value;\n        });\n        switch (button.getAttribute('data-action')) {\n            case 'delete':\n                buttons = form.querySelectorAll('[data-action=\"delete\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 1);\n                    }\n                }\n                break;\n            case 'left':\n                buttons = form.querySelectorAll('[data-action=\"left\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 2, mediafiles[i + 1], mediafiles[i]);\n                    }\n                }\n                break;\n            case 'right':\n                buttons = form.querySelectorAll('[data-action=\"right\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 2, mediafiles[i + 1], mediafiles[i]);\n                    }\n                }\n                break;\n            default:\n                break;\n        }\n        form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n        FormUpdate.updateForm(contextid, library, form);\n    }\n};\n"],"file":"editcontent.min.js"}