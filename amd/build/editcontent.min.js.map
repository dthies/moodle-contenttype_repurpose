{"version":3,"file":"editcontent.min.js","sources":["../src/editcontent.js"],"sourcesContent":["import FormUpdate from 'contenttype_repurpose/formupdate';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport Modal from 'core/modal_save_cancel';\nimport notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport templates from 'core/templates';\n\n/**\n * Initialize listeners\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n */\nexport const init = async(contextid, library, cmid) => {\n    'use strict';\n    let form;\n\n    try {\n        const modal = await Modal.create({\n            large: false,\n            title: getString('editmedia', 'contenttype_repurpose'),\n            body: ''\n        });\n        const root = modal.getRoot();\n        root.on('submit', function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n        root.on(ModalEvents.save, function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, cmid, form, data, modal);\n            modal.hide();\n        });\n\n        document.addEventListener('click', e => {\n            let button = e.target.closest('[data-action=\"edit\"], button[name=\"addfile\"]');\n            if (button) {\n                e.stopPropagation();\n                e.preventDefault();\n                form = e.target.closest('form');\n                editForm(contextid, library, cmid, form, button, modal);\n            }\n        }, true);\n    } catch (e) {\n        notification.exception(e);\n    }\n\n\n    document.addEventListener('click', edit.bind(window, contextid, library, cmid));\n};\n/**\n * Open editing modal\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {DOMNode} form Node for main form\n * @param {DOMNode} button The button that was clicked\n * @param {object} modal\n */\nconst editForm = function(contextid, library, cmid, form, button, modal) {\n    'use strict';\n\n    let buttons = form.querySelectorAll('[data-action=\"edit\"]'),\n        formdata = new FormData(form),\n        data = {\n            draftid: button.matches('[name=\"addfile\"]') && formdata.get('draftid'),\n            key: buttons.length\n        },\n        params = {\n            cmid: cmid,\n            contextid: contextid,\n            library: library\n        },\n        mediafiles = JSON.parse(formdata.get('mediafiles') || '[]');\n\n    for (let i = 0; i < buttons.length; i++) {\n        if (button.contains(buttons[i])) {\n            data.key = i;\n            data.title = mediafiles[i].metadata.title || null;\n            data.license = mediafiles[i].metadata.license || null;\n        }\n    }\n    params.jsonformdata = JSON.stringify(data);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n        modal.show();\n        templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n    }).fail(notification.exception);\n};\n\n/**\n * Submit form and handle response\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {DOMNode} form Node for main form\n * @param {FormData} data Modal data\n * @param {object} modal\n */\nconst saveForm = function(contextid, library, cmid, form, data, modal) {\n    'use strict';\n\n    let formdata = new FormData(form),\n        key = data.get('key'),\n        mediafiles = JSON.parse(formdata.get('mediafiles'));\n    if (!mediafiles[key]) {\n        let formdata = {},\n            params = {\n                cmid: cmid,\n                contextid: contextid,\n                library: library\n            };\n        data.forEach((value, key) => {\n            formdata[key] = value;\n        });\n        params.jsonformdata = JSON.stringify(formdata);\n        Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n            try {\n                let media = JSON.parse(html);\n                media.metadata.license = data.get('license');\n                mediafiles[key] = media;\n                form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n                FormUpdate.updateForm(contextid, library, cmid, form);\n            } catch (e) {\n                modal.show();\n                templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n            }\n        }).fail(notification.exception);\n    } else {\n        mediafiles[key].metadata.title = data.get('title');\n        mediafiles[key].metadata.license = data.get('license');\n        form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n        FormUpdate.updateForm(contextid, library, cmid, form);\n    }\n};\n\n/**\n * Handle editing action\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {int} cmid Question bank\n * @param {event} e Event\n */\nexport const edit = function(contextid, library, cmid, e) {\n    'use strict';\n\n    let button = e.target.closest('[data-action=\"delete\"], [data-action=\"left\"], [data-action=\"right\"]');\n    if (button) {\n        let buttons,\n            data = {},\n            form = e.target.closest('form'),\n            formdata = new FormData(form),\n            mediafiles = JSON.parse(formdata.get('mediafiles'));\n        e.stopPropagation();\n        e.preventDefault();\n\n        formdata.forEach((value, key) => {\n            data[key] = value;\n        });\n        switch (button.getAttribute('data-action')) {\n            case 'delete':\n                buttons = form.querySelectorAll('[data-action=\"delete\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 1);\n                    }\n                }\n                break;\n            case 'left':\n                buttons = form.querySelectorAll('[data-action=\"left\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 2, mediafiles[i + 1], mediafiles[i]);\n                    }\n                }\n                break;\n            case 'right':\n                buttons = form.querySelectorAll('[data-action=\"right\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 2, mediafiles[i + 1], mediafiles[i]);\n                    }\n                }\n                break;\n            default:\n                break;\n        }\n        form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n        FormUpdate.updateForm(contextid, library, cmid, form);\n    }\n};\n"],"names":["async","contextid","library","cmid","form","modal","Modal","create","large","title","body","root","getRoot","on","e","data","FormData","find","get","stopPropagation","preventDefault","saveForm","hide","ModalEvents","save","document","addEventListener","button","target","closest","editForm","exception","edit","bind","window","buttons","querySelectorAll","formdata","draftid","matches","key","length","params","mediafiles","JSON","parse","i","contains","metadata","license","jsonformdata","stringify","loadFragment","done","html","js","show","replaceNodeContents","fail","notification","querySelector","setAttribute","updateForm","forEach","value","media","getAttribute","item","splice"],"mappings":"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"}