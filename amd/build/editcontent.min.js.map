{"version":3,"file":"editcontent.min.js","sources":["../src/editcontent.js"],"sourcesContent":["import FormUpdate from 'contenttype_repurpose/formupdate';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport templates from 'core/templates';\n\n/**\n * Initialize listeners\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n */\nexport const init = (contextid, library) => {\n    'use strict';\n    let form;\n\n    ModalFactory.create({\n        large: false,\n        title: getString('editmedia', 'contenttype_repurpose'),\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: ''\n    }).then(function(modal) {\n        let root = modal.getRoot();\n        root.on('submit', function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n        root.on(ModalEvents.save, function(e) {\n            let data = new FormData(root.find('form').get(0));\n            e.stopPropagation();\n            e.preventDefault();\n            saveForm(contextid, library, form, data, modal);\n            modal.hide();\n        });\n\n        document.addEventListener('click', e => {\n            let button = e.target.closest('[data-action=\"edit\"], button[name=\"addfile\"]');\n            if (button) {\n                e.stopPropagation();\n                e.preventDefault();\n                form = e.target.closest('form');\n                editForm(contextid, library, form, button, modal);\n            }\n        }, true);\n\n        return true;\n    }).fail(notification.exception);\n\n    document.addEventListener('click', edit.bind(window, contextid, library));\n};\n/**\n * Open editing modal\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {DOMNode} form Node for main form\n * @param {DOMNode} button The button that was clicked\n * @param {object} modal\n */\nconst editForm = function(contextid, library, form, button, modal) {\n    'use strict';\n\n    let buttons = form.querySelectorAll('[data-action=\"edit\"]'),\n        formdata = new FormData(form),\n        data = {\n            draftid: button.matches('[name=\"addfile\"]') && formdata.get('draftid'),\n            key: buttons.length\n        },\n        params = {\n            contextid: contextid,\n            library: library\n        },\n        mediafiles = JSON.parse(formdata.get('mediafiles') || '[]');\n\n    for (let i = 0; i < buttons.length; i++) {\n        if (button.contains(buttons[i])) {\n            data.key = i;\n            data.title = mediafiles[i].metadata.title || null;\n            data.license = mediafiles[i].metadata.license || null;\n        }\n    }\n    params.jsonformdata = JSON.stringify(data);\n    Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n        modal.show();\n        templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n    }).fail(notification.exception);\n};\n\n/**\n * Submit form and handle response\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {DOMNode} form Node for main form\n * @param {FormData} data Modal data\n * @param {object} modal\n */\nconst saveForm = function(contextid, library, form, data, modal) {\n    'use strict';\n\n    let formdata = new FormData(form),\n        key = data.get('key'),\n        mediafiles = JSON.parse(formdata.get('mediafiles'));\n    if (!mediafiles[key]) {\n        let formdata = {},\n            params = {\n                contextid: contextid,\n                library: library\n            };\n        data.forEach((value, key) => {\n            formdata[key] = value;\n        });\n        params.jsonformdata = JSON.stringify(formdata);\n        Fragment.loadFragment('contenttype_repurpose', 'addfile', contextid, params).done(function(html, js) {\n            try {\n                let media = JSON.parse(html);\n                media.metadata.license = data.get('license');\n                mediafiles[key] = media;\n                form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n                FormUpdate.updateForm(contextid, library, form);\n            } catch (e) {\n                modal.show();\n                templates.replaceNodeContents(modal.getRoot().find('.modal-body'), html, js);\n            }\n        }).fail(notification.exception);\n    } else {\n        mediafiles[key].metadata.title = data.get('title');\n        mediafiles[key].metadata.license = data.get('license');\n        form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n        FormUpdate.updateForm(contextid, library, form);\n    }\n};\n\n/**\n * Handle editing action\n *\n * @param {int} contextid Context id of content bank\n * @param {string} library Library identifier\n * @param {event} e Event\n */\nexport const edit = function(contextid, library, e) {\n    'use strict';\n\n    let button = e.target.closest('[data-action=\"delete\"], [data-action=\"left\"], [data-action=\"right\"]');\n    if (button) {\n        let buttons,\n            data = {},\n            form = e.target.closest('form'),\n            formdata = new FormData(form),\n            mediafiles = JSON.parse(formdata.get('mediafiles'));\n        e.stopPropagation();\n        e.preventDefault();\n\n        formdata.forEach((value, key) => {\n            data[key] = value;\n        });\n        switch (button.getAttribute('data-action')) {\n            case 'delete':\n                buttons = form.querySelectorAll('[data-action=\"delete\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 1);\n                    }\n                }\n                break;\n            case 'left':\n                buttons = form.querySelectorAll('[data-action=\"left\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 2, mediafiles[i + 1], mediafiles[i]);\n                    }\n                }\n                break;\n            case 'right':\n                buttons = form.querySelectorAll('[data-action=\"right\"]');\n                for (let i = 0; i < buttons.length; i++) {\n                    if (button.contains(buttons.item(i))) {\n                        mediafiles.splice(i, 2, mediafiles[i + 1], mediafiles[i]);\n                    }\n                }\n                break;\n            default:\n                break;\n        }\n        form.querySelector('input[name=\"mediafiles\"]').setAttribute('value', JSON.stringify(mediafiles));\n        FormUpdate.updateForm(contextid, library, form);\n    }\n};\n"],"names":["contextid","library","form","create","large","title","type","ModalFactory","types","SAVE_CANCEL","body","then","modal","root","getRoot","on","e","data","FormData","find","get","stopPropagation","preventDefault","saveForm","hide","ModalEvents","save","document","addEventListener","button","target","closest","editForm","fail","notification","exception","edit","bind","window","buttons","querySelectorAll","formdata","draftid","matches","key","length","params","mediafiles","JSON","parse","i","contains","metadata","license","jsonformdata","stringify","loadFragment","done","html","js","show","replaceNodeContents","querySelector","setAttribute","updateForm","forEach","value","media","getAttribute","item","splice"],"mappings":"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"}